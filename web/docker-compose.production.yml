version: '3.8'

services:
  vibetunnel:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: vibetunnel-production
    restart: unless-stopped

    # Network configuration
    # Bind to localhost - Tailscale on host will proxy to this
    ports:
      - "127.0.0.1:4020:4020"

    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=4020
      # Disable authentication - Tailscale Serve will handle it
      # - VIBETUNNEL_NO_AUTH=true

      # Optional: Enable debug logging
      # - VIBETUNNEL_DEBUG=true

      # Optional: Custom control directory
      # - VIBETUNNEL_CONTROL_DIR=/data/control

      # Optional: Push notification settings
      # - PUSH_CONTACT_EMAIL=your-email@example.com

    # Persistent volumes
    volumes:
      # Session data and state
      - vibetunnel-data:/home/vibetunnel/.vibetunnel

      # Optional: Mount host directories for file access
      # - /path/on/host:/workspace:rw

      # Optional: Mount SSH keys for git operations
      # - ~/.ssh:/home/vibetunnel/.ssh:ro

      # Optional: Mount git config
      # - ~/.gitconfig:/home/vibetunnel/.gitconfig:ro

    # Resource limits (adjust based on your VPS)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4020/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  vibetunnel-data:
    driver: local
