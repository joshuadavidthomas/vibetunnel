version: '3.8'

# ============================================================================
# VibeTunnel with Tailscale - Coolify Deployment
# ============================================================================
#
# This Docker Compose file is optimized for Coolify deployment.
# Coolify will automatically detect environment variables and provide a UI to set them.
#
# REQUIRED ENVIRONMENT VARIABLES (set in Coolify UI):
#   - TS_AUTHKEY: Tailscale auth key (get from https://login.tailscale.com/admin/settings/keys)
#
# RECOMMENDED ENVIRONMENT VARIABLES:
#   - VIBETUNNEL_NO_AUTH: Set to "true" for tailnet-only access (no passwords)
#   - VIBETUNNEL_VERBOSITY: Logging level (none/error/warn/info/debug)
#   - PUSH_CONTACT_EMAIL: Your email for push notifications
#
# Coolify will show all ${VARIABLE:-default} as configurable options in the UI.
# ============================================================================

services:
  # Tailscale sidecar - provides secure access to your tailnet
  tailscale:
    image: tailscale/tailscale:latest
    container_name: vibetunnel-tailscale
    hostname: vibetunnel
    restart: unless-stopped

    environment:
      # REQUIRED: Tailscale auth key
      # Generate at: https://login.tailscale.com/admin/settings/keys
      # Recommendation: Create a reusable, tagged key with 90-day expiration
      - TS_AUTHKEY=${TS_AUTHKEY:?Error - TS_AUTHKEY is required. Generate one at https://login.tailscale.com/admin/settings/keys}

      # Tailscale configuration (do not change these)
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=true

      # ===== OPTIONAL TAILSCALE SETTINGS =====
      # Uncomment the following in Coolify if you want to customize:

      # Custom hostname on your tailnet (default: container name)
      # - TS_HOSTNAME=${TS_HOSTNAME:-vibetunnel}

      # Enable Tailscale SSH access to this container
      # - TS_SSH=${TS_SSH:-false}

    volumes:
      # Persistent Tailscale state (keeps your machine registered)
      - tailscale-state:/var/lib/tailscale

      # Optional: Tailscale Serve configuration
      # - ./tailscale-serve.json:/config/serve.json:ro

    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Health check
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - vibetunnel-network

  # VibeTunnel server
  vibetunnel:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: vibetunnel-app
    restart: unless-stopped

    # Depend on Tailscale being ready
    depends_on:
      tailscale:
        condition: service_healthy

    environment:
      # Node environment (do not change)
      - NODE_ENV=production
      - PORT=4020

      # ===== AUTHENTICATION =====
      # RECOMMENDED: Set to "true" for tailnet-only access (no password needed)
      # Set to "false" if you want to require username/password authentication
      - VIBETUNNEL_NO_AUTH=${VIBETUNNEL_NO_AUTH:-true}

      # OPTIONAL: Basic auth credentials (only used if VIBETUNNEL_NO_AUTH=false)
      # Uncomment these lines in Coolify if you want password protection:
      # - VIBETUNNEL_USERNAME=${VIBETUNNEL_USERNAME:-admin}
      # - VIBETUNNEL_PASSWORD=${VIBETUNNEL_PASSWORD:-changeme}

      # ===== LOGGING =====
      # Verbosity: none, error, warn, info, debug
      - VIBETUNNEL_VERBOSITY=${VIBETUNNEL_VERBOSITY:-info}

      # Debug mode (set to "true" for detailed logs)
      - VIBETUNNEL_DEBUG=${VIBETUNNEL_DEBUG:-false}

      # ===== PUSH NOTIFICATIONS =====
      # Email address for push notification VAPID configuration
      - PUSH_CONTACT_EMAIL=${PUSH_CONTACT_EMAIL:-noreply@vibetunnel.local}

      # ===== GIT CONFIGURATION =====
      # Git user info for terminal git operations
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-VibeTunnel}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-bot@vibetunnel.local}

    volumes:
      # Persistent session data
      - vibetunnel-data:/home/vibetunnel/.vibetunnel

      # Optional: Mount workspace directories from host
      # - ${WORKSPACE_PATH:-/data/workspace}:/workspace:rw

      # Optional: Mount SSH keys for git operations
      # - ${SSH_KEYS_PATH:-~/.ssh}:/home/vibetunnel/.ssh:ro

      # Optional: Mount git config
      # - ${GIT_CONFIG_PATH:-~/.gitconfig}:/home/vibetunnel/.gitconfig:ro

    # Expose port on the network (accessible to Tailscale container)
    expose:
      - "4020"

    # For local testing, you can expose the port (comment out for production)
    # ports:
    #   - "127.0.0.1:4020:4020"

    networks:
      - vibetunnel-network

    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4020/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Tailscale Serve proxy (optional - enables HTTPS with Tailscale identity auth)
  # Uncomment if you want Tailscale to handle HTTPS and authentication
  # tailscale-serve:
  #   image: tailscale/tailscale:latest
  #   container_name: vibetunnel-tailscale-serve
  #   restart: unless-stopped
  #   command: serve --bg --https=443 http://vibetunnel:4020
  #   depends_on:
  #     - tailscale
  #     - vibetunnel
  #   network_mode: "service:tailscale"
  #   volumes:
  #     - tailscale-state:/var/lib/tailscale:ro

networks:
  vibetunnel-network:
    driver: bridge

volumes:
  tailscale-state:
    driver: local
  vibetunnel-data:
    driver: local
